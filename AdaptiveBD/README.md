# AdaptiveBD

This is a (julia codebase)[https://julialang.org] which implements the [AdaptiveBD](https://aip.scitation.org/doi/10.1063/5.0062396) algorithm developed by Samüller et. al..
It is originally designed to simulate magnetic particles above magnetic patterns, but can in principle simulate arbitrary physical systems, by ignoring the "magnetic" parameters.

# Usage
The simulation is carried out on a `RSwM` struct.
Such a struct is generated by its constructor `RSwM(; s::System, dtTrial::Float64, relTol::Float64, absTol::Float64)` which takes as its first and most important argument a `System` struct.
## System
The `system` struct contains all the information about the physical system that is going to be simulated.
A `system` can be constructed with the `System(; ps::Vector{Particle}, T::Float64, γ::Float64, t::Float64, interactions::Tuple, externalForces::Tuple, pats)`.
`ps` is a Vector of `Particle` structs. `T` is the temperature, `\gamma` is the friction coefficient against the implicit solvent, `t` is the initial time, `interactions` is a tuple of functions that take two `particle`s as arguments and updated their forces. It is meant for internal interactions between the particles, `externalForces` on the other hand is is a tuple of functions that take one `particle` as an argument and, as its name suggests updates the external forces acting on the particle, `pats` is a list of magnetic patterns which can be set to an empty list, when no magnetic forces are part of the system.
## Particle
Particles can be constructed with the `Particle(r::AbstractVector, χ::Float64=1.0)` constructor, which takes a position `r`, and the magnetic susceptibility `\chi` as an argument.
The `\chi` can be ignored if no magnetic forces are part of the system, or used as a discriminator between different kinds of particles.

## Setting parameters of the simulation
`dtTrial` is the trial time-step used for the first step in the simulation. This parameter is not very important, as the algorithm chooses its time-step automagically afterwards. `1e-5` is a good starting point.
`relTol` is the relative error in the positions of the particles that is allowed during a time-step.
It has to be ajusted on a per system basis. A good rule of thumb is to set it to `1e-4`.
`absTol` is similar to `relTol` but secifies the maximum allowed absulute error in the positions of the particles. A good rule of thumb is to set it to `1e-6`.

## Starting a simulation
 - Construct particles, e.g. `ps = [Particle(rand(2)) for _ in 1:10]`
 - Define functions that update the internal and external forces acting on the particles. An example for an harmonic oscillator would be:
 ```
function harmonic!(p::Particle)
    k = 1.0
    p.F -= k * p.r
    nothing
end
 ```
 and for Lenard-Jones interaction:
 ```
function LJ(p1, p2)
    cutoff = 3.0
    ε = 1.0
    σ = 1.0
    Δr = p1.r - p2.r
    r2 = Δr ⋅ Δr
    if r2 > cutoff^2
        return nothing
    end
    F = ε / r2 * (2(σ^12 / r2^6) - (σ^6 / r2^3)) * Δr
    p1.F += F
    p2.F -= F
    nothing
end
 ```
 - Construct a system with your `particle`s and forces, e.g. `s = System(ps=ps, T=0.1, γ=1.0, t=0.0, interactions=(LJ,), externalForces=(harmonic,), pats=[] )`
 - Construct a `RSwM` object by `r = RSwM(s=s)`
 - Start a simulation running until `t=100.0` which samples the trajectories every `dt=0.1` by `dts, traj, ts = solve(r, 100.0, 0.1)`
 - `dts` is a `Queue` of the timesteps that were used at the time of sampling. These sampling times are stored in `ts` which is also a `Queue`. `traj` is a `Queue` of the trajectories of the particles, stored in `BareParticle`s which are a barebones version of the `particle` struct, which only includes the positions and the susceptibility. In a future version, the `Queue`s will be changed to `Vector`s
